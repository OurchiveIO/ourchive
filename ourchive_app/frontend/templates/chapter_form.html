{% extends 'index.html' %}
{% block content %}	
{% load static %}
<script src="{% static 'frontend/js/tinymce.min.js' %}"></script>
<div id="chapter-form-parent" class="uk-width-1-1 uk-text-left"> 
	<form class="uk-form-horizontal"  method="post" id="chapterForm" onsubmit="return getRichTextValues()">
		<script>
	        function getRichTextValues() {
	        	document.getElementById('summary').value = tinymce.get("summaryEditor").getContent().replace(/\r?\n?/g, '');
            	document.getElementById('notes').value = tinymce.get("notesEditor").getContent().replace(/\r?\n?/g, '');
            	if (document.getElementById('chapter-text-edit-mode-toggle').checked) {
		            document.getElementById('chapter_text').value = tinymce.get("textEditor").getContent().replace(/\r?\n?/g, '');
		        } else {
		            document.getElementById('chapter_text').value = document.getElementById('toggle-chapter-plaintext-area').value;
		        }
	        }

	        function updateModeText() {
	        	if (document.getElementById('chapter-text-edit-mode-toggle').checked) {
	        		tinymce.get("textEditor").setContent(document.getElementById('toggle-chapter-plaintext-area').value);
	        	}
	        	else {
	        		const grafEx = new RegExp('<p>', "g");
	        		const whEx = new RegExp('</p>', "g");
	        		document.getElementById('toggle-chapter-plaintext-area').innerHTML = tinymce.get("textEditor").getContent().replace(/\r?\n?/g, '').replace(grafEx, '\n').replace(whEx, '').replace('\n', '');
	        	}
	        }
    	</script>
		{% csrf_token %}
		<input type="hidden" id="work" name="work" value="{{ chapter.work }}">
		<input type="hidden" id="work" name="chapter_id" value="{{ chapter.id }}">
		<div id="chapter-form-title-grid" class="uk-child-width-1@m uk-child-width-1@s uk-text-left" uk-grid>
	        <div class="uk-width-2-3" id="chapter-form-title-div">
	            <span id="chapter-form-title-span" class="uk-text-large">{{ chapter.title|default_if_none:'' }}</span>
	        </div>
	        <div class="uk-text-right uk-width-1-3" id="chapter-form-buttons-parent">
	        	<input id="chapter-form-cancel-button" class="uk-button uk-button-secondary" type="button" onclick="history.back()" value="Cancel"/>
	            <input id="chapter-form-submit-button" class="uk-button uk-button-primary" type="submit" value="Submit"/>
	        </div>
	    </div>
    <hr id="chapter-form-hr"/>
		<fieldset class="uk-fieldset" id="chapter-form-fieldset">
		<div id="chapter-form-title-parent" class="uk-margin">
            <label id="chapter-form-title-label" class="uk-form-label" for="form-horizontal-text">Title</label>
            <div id="chapter-form-title-controls" class="uk-form-controls">
                <div id="chapter-form-title-inline" class="uk-inline">
                    <input id="chapter-form-title-input" class="uk-input uk-form-width-large" type="text" name="title" value="{{ chapter.title|default_if_none:'' }}">
                </div>
            </div>
            
        </div>

        <div class="uk-margin" id="chapter-form-summary-parent">
            <label id="chapter-form-summary-label" class="uk-form-label" for="form-horizontal-text">Summary</label>
            <div id="chapter-form-summary-controls" class="uk-form-controls">
                <div id="chapter-form-summary-inline" class="uk-inline">
                    <input type="hidden" id="summary" name="summary" value="{{ chapter.summary|safe|default_if_none:'' }}">
                    <textarea id="summaryEditor"></textarea>
                    <script type="text/javascript">
                                      tinymce.init({
                                        selector: '#summaryEditor',
                                        width: '100%',
										height: 450,
										autoresize_min_height: 450,
										autoresize_max_height: 800,
                                        plugins: [
                                          'link', 'image', 'lists', 'charmap', 'preview', 'anchor', 'pagebreak',
                                          'fullscreen', 'insertdatetime',
                                          'media', 'table', 'emoticons'
                                        ],
                                        toolbar: 'undo redo | styles | bold italic | alignleft aligncenter alignright alignjustify | ' +
                                          'bullist numlist outdent indent | link image | print preview media fullscreen | ' +
                                          'forecolor backcolor emoticons | help',
                                        menubar: '',
                                        content_css: 'css/content.css',
                                        init_instance_callback : function(editor) {
                                        	var chapterSummary = document.getElementById('summary').value;
                                        	if (chapterSummary === "None") {
                                        		chapterSummary = '';
                                        	}
                                            editor.setContent(chapterSummary);
                                        }
                                      });
                   </script>
                </div>
            </div>
        </div>

       <div class="uk-margin" id="chapter-form-number-parent">
            <label id="chapter-form-number-label" class="uk-form-label" for="form-horizontal-text">Number</label>
            <div id="chapter-form-number-controls" class="uk-form-controls">
                <div id="chapter-form-number-inline" class="uk-inline">
                    <input id="chapter-form-number-input" class="uk-input" type="number" name="number" min="1" value="{{ chapter.number }}">
                </div>
            </div>            
        </div>

        <div class="uk-margin" id="chapter-form-draft-parent">
            <label id="chapter-form-draft-label" class="uk-form-label" for="form-horizontal-text">Draft?</label>
            <div class="uk-form-controls" id="chapter-form-draft-controls">
                <div class="uk-inline" id="chapter-form-draft-inline">
                    <label id="chapter-form-draft-checkbox-label" class="switch"><input class="uk-checkbox" type="checkbox" id="chapter-form-draft" name="draft" {% if chapter.draft %} checked {% endif %}> <span class="slider round"></span></label>
                </div>
            </div>
        </div>

        <div class="uk-margin" id="chapter-form-notes-parent">
            <label class="uk-form-label" for="form-horizontal-text" id="chapter-form-notes-label">Notes</label>
            <div class="uk-form-controls" id="chapter-form-notes-controls">
                <div class="uk-inline" id="chapter-form-notes-inline">
                    <input type="hidden" id="notes" name="notes" value="{{ chapter.notes|safe|default_if_none:'' }}">
                    <textarea id="notesEditor"></textarea>
                    <script type="text/javascript">
                                      tinymce.init({
                                        selector: '#notesEditor',
                                        width: '100%',
										height: 450,
										autoresize_min_height: 450,
										autoresize_max_height: 800,
                                        plugins: [
                                          'link', 'image', 'lists', 'charmap', 'preview', 'anchor', 'pagebreak',
                                          'fullscreen', 'insertdatetime',
                                          'media', 'table', 'emoticons'
                                        ],
                                        toolbar: 'undo redo | styles | bold italic | alignleft aligncenter alignright alignjustify | ' +
                                          'bullist numlist outdent indent | link image | print preview media fullscreen | ' +
                                          'forecolor backcolor emoticons | help',
                                        menubar: '',
                                        content_css: 'css/content.css',
                                        init_instance_callback : function(editor) {
                                        	var chapterNotes = document.getElementById('notes').value;
                                        	if (chapterNotes === "None") {
                                        		chapterNotes = '';
                                        	}
                                            editor.setContent(chapterNotes);
                                        }
                                      });
                   </script>
                </div>
            </div>
        </div>

        <hr id="chapter-attributes-hr"/>
        	{% include "object_attributes_form.html" with object='Chapter' attribute_types=chapter.attribute_types %}
        <hr id="chapter-comments-hr"/>

        <div class="uk-margin" id="chapter-form-image-parent">
            <label id="chapter-form-image-label" class="uk-form-label" for="form-horizontal-text">Chapter Image</label>
            {% if chapter.image_url %}
                <img id="chapter-form-image" src="{{ chapter.image_url }}"/>
            {% endif %}
            <div class="uk-form-controls" id="chapter-form-image-upload-controls">
                <div class="uk-inline" id="chapter-form-image-upload-inline">
                	<div id="chapter-form-image-upload-placeholder" class="js-upload-img uk-placeholder uk-text-center">
                    <span id="chapter-form-image-upload-icon" uk-icon="icon: cloud-upload"></span>
				    <div uk-form-custom="target: true">
			            <input type="file">
			            <input class="uk-input uk-form-width-medium" id="js-img-input" type="text" placeholder="Select file" name="image_url">
			        </div>
				    <progress id="js-progressbar-img" class="uk-progress" value="0" max="100" hidden></progress>
				    <script>
					    var bar = document.getElementById('js-progressbar-img');

					    UIkit.upload('.js-upload-img', {

					        url: '',
					        multiple: false,

					        beforeSend: function () {
					            function getCookie(name) {
					                var cookieValue = null;
					                if (document.cookie && document.cookie !== '') {
					                    var cookies = document.cookie.split(';');
					                    cookies.forEach(function (value) { 
					                        var cookie = value.trim();
					                        // Does this cookie string begin with the name we want?
					                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
					                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
					                            return;
					                        }
					                    });
					                }
					                return cookieValue;
					            }
					            var csrftoken = getCookie('csrftoken');
					            arguments[0]['headers']['X-CSRFToken'] = csrftoken;
					            console.log('beforeSend', arguments);
					        },
					        beforeAll: function () {
					            console.log('beforeAll', arguments);
					        },
					        load: function () {
					            console.log('load', arguments);
					        },
					        error: function () {
					            console.log('error', arguments);
					        },
					        complete: function () {
					            console.log('complete', arguments);
					        },

					        loadStart: function (e) {
					            console.log('loadStart', arguments);

					            bar.removeAttribute('hidden');
					            bar.max = e.total;
					            bar.value = e.loaded;
					        },

					        progress: function (e) {
					            console.log('progress', arguments);

					            bar.max = e.total;
					            bar.value = e.loaded;
					        },

					        loadEnd: function (e) {
					            console.log('loadEnd', arguments);

					            bar.max = e.total;
					            bar.value = e.loaded;
					        },

					        completeAll: function () {
					            console.log('completeAll', arguments);

					            setTimeout(function () {
					                bar.setAttribute('hidden', 'hidden');
					            }, 1000);

					            document.getElementById('js-img-input').value = arguments[0]['response'];
					        }

					    });

					</script>
				</div>

                </div>
            </div>
        </div>

        <div class="uk-margin" id="chapter-form-image-alt-text-parent">
            <label id="chapter-form-image-alt-text-label" class="uk-form-label" for="form-horizontal-text">Image Alt Text</label>
            <div id="chapter-form-image-alt-text-controls" class="uk-form-controls">
                <div class="uk-inline" id="chapter-form-image-alt-text-inline">
                    <textarea id="chapter-form-image-alt-text" class="uk-textarea uk-form-width-large" rows="2" placeholder="Image alt text" name="image_alt_text" maxlength="600">{{ chapter.image_alt_text|default_if_none:'' }}</textarea>
                </div>
            </div>
        </div>

        <div class="uk-margin" id="chapter-form-audio-parent">
            <label id="chapter-form-audio-label" class="uk-form-label" for="form-horizontal-text">Chapter Audio</label>
            <div class="uk-form-controls" id="chapter-form-audio-controls">
                <div class="uk-inline" id="chapter-form-audio-inline">
                	<div id="chapter-form-audio-placeholder" class="js-upload-audio uk-placeholder uk-text-center">
                    <span id="chapter-form-audio-icon" uk-icon="icon: cloud-upload"></span>
				    <div uk-form-custom="target: true">
			            <input type="file">
			            <input class="uk-input uk-form-width-medium" id="js-audio-input" type="text" placeholder="Select file" name="audio_url">
			        </div>

				    <progress id="js-progressbar-audio" class="uk-progress" value="0" max="100" hidden></progress>
				    <script>
					    var bar = document.getElementById('js-progressbar-audio');
					    UIkit.upload('.js-upload-audio', {

					        url: '',
					        multiple: false,

					        beforeSend: function () {
					            function getCookie(name) {
					                var cookieValue = null;
					                if (document.cookie && document.cookie !== '') {
					                    var cookies = document.cookie.split(';');
					                    cookies.forEach(function (value) { 
					                        var cookie = value.trim();
					                        // Does this cookie string begin with the name we want?
					                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
					                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
					                            return;
					                        }
					                    });
					                }
					                return cookieValue;
					            }
					            var csrftoken = getCookie('csrftoken');
					            arguments[0]['headers']['X-CSRFToken'] = csrftoken;
					            console.log('beforeSend', arguments);

					        },
					        beforeAll: function () {
					            console.log('beforeAll', arguments);
					        },
					        load: function () {
					            console.log('load', arguments);
					        },
					        error: function () {
					            console.log('error', arguments);
					        },
					        complete: function () {
					            console.log('complete', arguments);
					        },

					        loadStart: function (e) {
					            console.log('loadStart', arguments);

					            bar.removeAttribute('hidden');
					            bar.max = e.total;
					            bar.value = e.loaded;
					        },

					        progress: function (e) {
					            console.log('progress', arguments);

					            bar.max = e.total;
					            bar.value = e.loaded;
					        },

					        loadEnd: function (e) {
					            console.log('loadEnd', arguments);

					            bar.max = e.total;
					            bar.value = e.loaded;
					        },

					        completeAll: function () {
					            console.log('completeAll', arguments);

					            setTimeout(function () {
					                bar.setAttribute('hidden', 'hidden');
					            }, 1000);

					            document.getElementById('js-audio-input').value = arguments[0]['response'];
					        }

					    });

					</script>
				</div>

                </div>
            </div>
        </div>

        <div class="uk-margin" id="chapter-form-audio-description-parent">
            <label id="chapter-form-audio-description-label" class="uk-form-label" for="form-horizontal-text">Audio Description</label>
            <div id="chapter-form-audio-description-controls" class="uk-form-controls">
                <div class="uk-inline" id="chapter-form-audio-description-inline">
                    <textarea id="chapter-form-audio-description" class="uk-textarea uk-form-width-large" rows="2" placeholder="Audio description" name="audio_description" maxlength="600">{{ chapter.audio_description|default_if_none:'' }}</textarea>
                </div>
            </div>
        </div>

        <div class="uk-margin" id="chapter-form-text-parent">
            <label id="chapter-form-text-label" class="uk-form-label" for="form-horizontal-text">Chapter Text</label>
            <div class="uk-form-controls" id="chapter-form-text-controls">
                <div class="uk-inline uk-width-expand" id="chapter-form-text-inline">
                	<div class="uk-margin-bottom">
                	<span width="150" class="uk-form-label" id="chapter-edit-mode-toggle-label">Rich Text?</span>
                	<label id="chapter-text-edit-mode-label" class="switch uk-width-medium"><input class="uk-checkbox" type="checkbox" id="chapter-text-edit-mode-toggle" onclick="return updateModeText()" checked uk-toggle="target: .chapter-text-toggle")> 
                		<span class="slider round"></span></label>
                	</div>
                	<input type="hidden" id="chapter_text" name="text" value="{{ chapter.text|safe|default_if_none:'' }}">
                    <textarea id="textEditor"></textarea>
                    <script type="text/javascript">
                                      tinymce.init({
                                        selector: '#textEditor',
                                        width: '100%',
										height: 450,
										autoresize_min_height: 450,
										autoresize_max_height: 800,
                                        plugins: [
                                          'link', 'image', 'lists', 'charmap', 'preview', 'anchor', 'pagebreak',
                                          'fullscreen', 'insertdatetime',
                                          'media', 'table', 'emoticons'
                                        ],
                                        toolbar: 'undo redo | styles | bold italic | alignleft aligncenter alignright alignjustify | ' +
                                          'bullist numlist outdent indent | link image | print preview media fullscreen | ' +
                                          'forecolor backcolor emoticons | help',
                                        menubar: '',
                                        setup : function(ed) {
										    ed.on('init', function(event) {
										      ed.getContainer().classList.add("chapter-text-toggle");
										    });
										},
                                        init_instance_callback : function(editor) {
                                        	var chapterText = document.getElementById('chapter_text').value;
                                            editor.setContent(chapterText);
                                        }
                                      });
                   </script>
                </div>
                <div class="uk-width-1-1" id="chapter-form-html-text">
                    <textarea id="toggle-chapter-plaintext-area" rows="25" name="text-plain" class="chapter-text-toggle uk-width-expand" hidden>{{ chapter.text|safe|default_if_none:'' }}</textarea>
                </div>
            </div>
        </div>
    </fieldset>
	</form>
</div>
{% endblock %}